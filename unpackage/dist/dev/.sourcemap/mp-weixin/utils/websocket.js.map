{"version":3,"file":"websocket.js","sources":["utils/websocket.js"],"sourcesContent":["// WebSocket 工具类（简化版，不使用 STOMP）\nimport { API_BASE_URL } from './api.config.js'\n\nclass WebSocketManager {\n  constructor() {\n    this.socket = null\n    this.reconnectTimer = null\n    this.reconnectAttempts = 0\n    this.maxReconnectAttempts = 5\n    this.reconnectInterval = 3000\n    this.isConnected = false\n    this.onMessageCallback = null\n    this.onErrorCallback = null\n    this.userId = null\n  }\n\n  /**\n   * 连接 WebSocket\n   * @param {string} userId - 用户ID\n   * @param {function} onMessage - 消息回调\n   * @param {function} onError - 错误回调\n   */\n  connect(userId, onMessage, onError) {\n    this.userId = userId\n    this.onMessageCallback = onMessage\n    this.onErrorCallback = onError\n\n    // 如果已有连接且正在连接中，不重复连接\n    if (this.socket) {\n      if (this.socket instanceof WebSocket) {\n        // 原生 WebSocket\n        if (this.socket.readyState === WebSocket.CONNECTING || this.socket.readyState === WebSocket.OPEN) {\n          console.log('WebSocket 正在连接或已连接，跳过重复连接')\n          return\n        }\n      } else {\n        // uni-app WebSocket\n        if (this.isConnected) {\n          console.log('WebSocket 已连接')\n          return\n        }\n      }\n    }\n\n    // 清理旧连接\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer)\n      this.reconnectTimer = null\n    }\n\n    try {\n      // 构建 WebSocket URL\n      // 将 http:// 或 https:// 替换为 ws:// 或 wss://\n      let baseUrl = API_BASE_URL.trim().replace(/^http/, 'ws')\n      \n      // 注意：由于 servlet context-path 是 /api，WebSocket 路径也需要包含 /api\n      // 测试结果显示只有 /api/ws/chat 能连接成功\n      // 保持 /api 前缀，添加 WebSocket 路径和用户ID参数\n      let wsUrl = `${baseUrl}/ws/chat?userId=${userId}`\n      \n      console.log('=== WebSocket 连接信息 ===')\n      console.log('原始 API URL:', API_BASE_URL)\n      console.log('转换后基础 URL:', baseUrl)\n      console.log('完整 WebSocket URL:', wsUrl)\n      console.log('用户ID:', userId)\n\n      // 在 H5 环境下，优先使用原生 WebSocket（更稳定）\n      // 注意：某些浏览器可能不支持原生 WebSocket，需要降级到 uni-app API\n      if (typeof WebSocket !== 'undefined' && typeof window !== 'undefined') {\n        try {\n          console.log('检测到 WebSocket API，使用原生 WebSocket')\n          this.socket = new WebSocket(wsUrl)\n          this.setupNativeWebSocket()\n          return\n        } catch (nativeError) {\n          console.warn('原生 WebSocket 创建失败，使用 uni-app API:', nativeError)\n        }\n      }\n\n      // 使用 uni-app 的 WebSocket API（小程序环境）\n      this.socket = uni.connectSocket({\n        url: wsUrl,\n        header: {\n          'userId': userId.toString()\n        },\n        success: () => {\n          console.log('✓ WebSocket 连接请求已发送')\n        },\n        fail: (err) => {\n          console.error('✗ WebSocket 连接请求失败:', err)\n          console.error('失败详情:', JSON.stringify(err, null, 2))\n          if (onError) onError(err)\n          this.scheduleReconnect()\n        }\n      })\n\n      // 监听连接打开\n      this.socket.onOpen(() => {\n        console.log('✓ WebSocket 连接成功打开')\n        this.isConnected = true\n        this.reconnectAttempts = 0\n      })\n\n      // 监听消息\n      this.socket.onMessage((res) => {\n        console.log('收到 WebSocket 消息:', res.data)\n        try {\n          const data = JSON.parse(res.data)\n          if (this.onMessageCallback) {\n            this.onMessageCallback(data)\n          }\n        } catch (e) {\n          console.error('解析消息失败:', e, res.data)\n        }\n      })\n\n      // 监听错误\n      this.socket.onError((err) => {\n        console.error('✗ WebSocket 错误:', err)\n        console.error('错误类型:', typeof err)\n        console.error('错误详情:', JSON.stringify(err, null, 2))\n        console.error('错误消息:', err?.message || err?.errMsg || '未知错误')\n        console.error('错误代码:', err?.errCode || 'N/A')\n        this.isConnected = false\n        if (this.onErrorCallback) {\n          this.onErrorCallback(err)\n        }\n      })\n\n      // 监听关闭\n      this.socket.onClose((res) => {\n        console.log('WebSocket 已关闭')\n        console.log('关闭原因:', res?.code, res?.reason || '未知')\n        this.isConnected = false\n        this.scheduleReconnect()\n      })\n\n    } catch (error) {\n      console.error('创建 WebSocket 连接失败:', error)\n      if (onError) onError(error)\n    }\n  }\n\n  /**\n   * 发送消息\n   */\n  send(type, data) {\n    if (!this.socket || !this.isConnected) {\n      console.error('WebSocket 未连接')\n      return false\n    }\n\n    try {\n      const message = {\n        type: type,\n        ...data\n      }\n      const messageStr = JSON.stringify(message)\n      \n      // 原生 WebSocket\n      if (this.socket instanceof WebSocket) {\n        this.socket.send(messageStr)\n        console.log('✓ 原生 WebSocket 消息已发送:', type)\n        return true\n      }\n      \n      // uni-app WebSocket\n      this.socket.send({\n        data: messageStr,\n        success: () => {\n          console.log('✓ uni-app WebSocket 消息已发送:', type)\n        },\n        fail: (err) => {\n          console.error('✗ 发送消息失败:', err)\n        }\n      })\n      return true\n    } catch (error) {\n      console.error('发送消息错误:', error)\n      return false\n    }\n  }\n\n  /**\n   * 断开连接\n   */\n  disconnect() {\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer)\n      this.reconnectTimer = null\n    }\n\n    if (this.socket) {\n      // 原生 WebSocket\n      if (this.socket instanceof WebSocket) {\n        this.socket.close()\n        console.log('原生 WebSocket 已断开')\n      } else {\n        // uni-app WebSocket\n        this.socket.close({\n          success: () => {\n            console.log('uni-app WebSocket 已断开')\n          }\n        })\n      }\n      this.socket = null\n    }\n    this.isConnected = false\n    this.reconnectAttempts = 0\n    this.onMessageCallback = null\n    this.onErrorCallback = null\n  }\n\n  /**\n   * 设置原生 WebSocket 事件监听（H5 环境）\n   */\n  setupNativeWebSocket() {\n    if (!this.socket) return\n    \n    this.socket.onopen = () => {\n      console.log('✓ 原生 WebSocket 连接成功打开')\n      console.log('WebSocket 状态:', this.socket.readyState)\n      this.isConnected = true\n      this.reconnectAttempts = 0\n      // 清除重连定时器\n      if (this.reconnectTimer) {\n        clearTimeout(this.reconnectTimer)\n        this.reconnectTimer = null\n      }\n    }\n    \n    this.socket.onmessage = (event) => {\n      console.log('收到原生 WebSocket 消息:', event.data)\n      try {\n        const data = JSON.parse(event.data)\n        if (this.onMessageCallback) {\n          this.onMessageCallback(data)\n        }\n      } catch (e) {\n        console.error('解析消息失败:', e, event.data)\n      }\n    }\n    \n    this.socket.onerror = (error) => {\n      console.error('✗ 原生 WebSocket 错误:', error)\n      console.error('WebSocket 状态:', this.socket?.readyState)\n      this.isConnected = false\n      if (this.onErrorCallback) {\n        this.onErrorCallback(error)\n      }\n    }\n    \n    this.socket.onclose = (event) => {\n      console.log('原生 WebSocket 已关闭')\n      console.log('关闭代码:', event.code)\n      console.log('关闭原因:', event.reason || '无')\n      console.log('WebSocket 状态:', this.socket?.readyState)\n      this.isConnected = false\n      \n      // 只有非正常关闭（非 1000）或非主动断开时才重连\n      // 1000 是正常关闭，可能是后端主动关闭或页面切换导致\n      if (event.code !== 1000 && event.code !== 1001) {\n        console.log('非正常关闭，将尝试重连')\n        this.scheduleReconnect()\n      } else {\n        console.log('正常关闭，不重连')\n        // 如果是正常关闭，清除重连定时器\n        if (this.reconnectTimer) {\n          clearTimeout(this.reconnectTimer)\n          this.reconnectTimer = null\n        }\n      }\n    }\n  }\n\n  /**\n   * 安排重连\n   */\n  scheduleReconnect() {\n    if (!this.userId) {\n      console.log('用户ID为空，不重连')\n      return\n    }\n    \n    // 如果已经连接，不重连\n    if (this.isConnected) {\n      console.log('WebSocket 已连接，不重连')\n      return\n    }\n    \n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      console.error('达到最大重连次数，停止重连')\n      return\n    }\n\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer)\n    }\n\n    this.reconnectAttempts++\n    console.log(`将在 ${this.reconnectInterval}ms 后尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})`)\n\n    this.reconnectTimer = setTimeout(() => {\n      console.log('尝试重连 WebSocket...')\n      // 重置 socket，确保重新创建连接\n      this.socket = null\n      this.connect(this.userId, this.onMessageCallback, this.onErrorCallback)\n    }, this.reconnectInterval)\n  }\n}\n\n// 创建单例\nconst wsManager = new WebSocketManager()\n\nexport default wsManager\n"],"names":["uni","API_BASE_URL"],"mappings":"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"}