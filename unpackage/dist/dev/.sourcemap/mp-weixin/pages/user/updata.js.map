{"version":3,"file":"updata.js","sources":["pages/user/updata.vue","../../hbuildx/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci91cGRhdGEudnVl"],"sourcesContent":["<template>\n\t<view class=\"container\">\n\t\t<view class=\"header\">\n\t\t\t<text class=\"title\">编辑资料</text>\n\t\t</view>\n\t\t\n\t\t<view class=\"form-section\">\n\t\t\t<!-- 头像编辑 -->\n\t\t\t<view class=\"avatar-section\">\n\t\t\t\t<text class=\"section-label\">头像</text>\n\t\t\t\t<view class=\"avatar-wrapper\" @click=\"chooseAvatar\">\n\t\t\t\t\t<image class=\"avatar\" :src=\"form.avatar || '/static/default-avatar.png'\" mode=\"aspectFill\"></image>\n\t\t\t\t\t<view class=\"avatar-mask\">\n\t\t\t\t\t\t<text class=\"avatar-text\">点击更换</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 昵称编辑 -->\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">昵称</text>\n\t\t\t\t<input class=\"input\" v-model=\"form.username\" placeholder=\"请输入昵称\" maxlength=\"20\" />\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 其他信息（可选） -->\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">邮箱</text>\n\t\t\t\t<input class=\"input\" v-model=\"form.email\" placeholder=\"请输入邮箱（可选）\" type=\"email\" />\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">所在地区</text>\n\t\t\t\t<input class=\"input\" v-model=\"form.address\" placeholder=\"请输入所在地区（可选）\" />\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 保存按钮 -->\n\t\t\t<button class=\"save-btn\" @click=\"handleSave\" :disabled=\"saving\">\n\t\t\t\t{{ saving ? '保存中...' : '保存' }}\n\t\t\t</button>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\nimport { ref } from 'vue'\nimport { onLoad } from '@dcloudio/uni-app'\nimport { userApi } from '@/utils/apiService.js'\nimport { getCurrentUser, getCurrentUserId, checkLogin, saveUserInfo } from '@/utils/auth.js'\n\nconst form = ref({\n\tid: null,\n\tusername: '',\n\tavatar: '',\n\temail: '',\n\taddress: ''\n})\n\nconst saving = ref(false)\n\nonLoad(() => {\n\tif (!checkLogin()) {\n\t\tuni.navigateBack()\n\t\treturn\n\t}\n\t\n\t// 加载当前用户信息\n\tconst currentUser = getCurrentUser()\n\tif (currentUser) {\n\t\tform.value = {\n\t\t\tid: currentUser.id,\n\t\t\tusername: currentUser.username || '',\n\t\t\tavatar: currentUser.avatar || '',\n\t\t\temail: currentUser.email || '',\n\t\t\taddress: currentUser.address || ''\n\t\t}\n\t}\n})\n\n// 选择头像\nfunction chooseAvatar() {\n\tuni.chooseImage({\n\t\tcount: 1,\n\t\tsizeType: ['compressed'],\n\t\tsourceType: ['album', 'camera'],\n\t\tsuccess: (res) => {\n\t\t\tconst tempFilePath = res.tempFilePaths[0]\n\t\t\t\n\t\t\t// 显示预览\n\t\t\tform.value.avatar = tempFilePath\n\t\t\t\n\t\t\t// 上传头像到服务器\n\t\t\tuploadAvatar(tempFilePath)\n\t\t},\n\t\tfail: (err) => {\n\t\t\tconsole.error('选择图片失败:', err)\n\t\t\tuni.showToast({ title: '选择图片失败', icon: 'none' })\n\t\t}\n\t})\n}\n\n// 上传头像\nasync function uploadAvatar(filePath) {\n\ttry {\n\t\tuni.showLoading({ title: '上传中...' })\n\t\t\n\t\tconst userId = getCurrentUserId()\n\t\tif (!userId) {\n\t\t\tuni.hideLoading()\n\t\t\tuni.showToast({ title: '用户信息错误', icon: 'none' })\n\t\t\treturn\n\t\t}\n\t\t\n\t\t// 方案1：如果配置了OSS，先上传到OSS\n\t\t// 方案2：如果后端支持文件上传，使用 uni.uploadFile 上传到后端\n\t\t// 方案3：临时使用本地路径（仅用于测试，实际应该上传到OSS）\n\t\t\n\t\t// 这里先使用临时方案：直接使用临时路径\n\t\t// TODO: 如果配置了OSS，应该先上传到OSS获取URL\n\t\t// const ossUrl = await uploadToOSS(filePath)\n\t\t// const avatarUrl = ossUrl\n\t\t\n\t\tconst avatarUrl = filePath\n\t\t\n\t\t// 更新头像到后端\n\t\tawait userApi.updateAvatar(userId, avatarUrl)\n\t\tform.value.avatar = avatarUrl\n\t\t\n\t\t// 更新本地用户信息\n\t\tconst updatedUser = await userApi.getUserInfo(userId)\n\t\tif (updatedUser) {\n\t\t\tsaveUserInfo(updatedUser, uni.getStorageSync('token'))\n\t\t}\n\t\t\n\t\tuni.hideLoading()\n\t\tuni.showToast({ title: '头像上传成功', icon: 'success' })\n\t} catch (error) {\n\t\tconsole.error('上传头像失败:', error)\n\t\tuni.hideLoading()\n\t\tuni.showToast({ \n\t\t\ttitle: error.message || '上传头像失败', \n\t\t\ticon: 'none' \n\t\t})\n\t}\n}\n\n// 保存用户信息\nasync function handleSave() {\n\t// 验证\n\tif (!form.value.username || form.value.username.trim() === '') {\n\t\tuni.showToast({ title: '请输入昵称', icon: 'none' })\n\t\treturn\n\t}\n\t\n\tif (saving.value) {\n\t\treturn\n\t}\n\t\n\tsaving.value = true\n\t\n\ttry {\n\t\tconst userId = getCurrentUserId()\n\t\tif (!userId) {\n\t\t\tuni.showToast({ title: '用户信息错误', icon: 'none' })\n\t\t\treturn\n\t\t}\n\t\t\n\t\t// 更新昵称\n\t\tconst currentUser = getCurrentUser()\n\t\tif (form.value.username !== currentUser?.username) {\n\t\t\tawait userApi.updateUsername(userId, form.value.username)\n\t\t}\n\t\t\n\t\t// 更新其他信息（使用通用更新接口）\n\t\tif (form.value.email !== currentUser?.email || form.value.address !== currentUser?.address) {\n\t\t\tawait userApi.updateUser(userId, {\n\t\t\t\temail: form.value.email || '',\n\t\t\t\taddress: form.value.address || ''\n\t\t\t})\n\t\t}\n\t\t\n\t\t// 获取最新用户信息\n\t\tconst updatedUser = await userApi.getUserInfo(userId)\n\t\t\n\t\t// 更新本地存储\n\t\tif (updatedUser) {\n\t\t\tsaveUserInfo(updatedUser, uni.getStorageSync('token'))\n\t\t}\n\t\t\n\t\tuni.showToast({ title: '保存成功', icon: 'success' })\n\t\t\n\t\t// 延迟返回，让用户看到成功提示\n\t\tsetTimeout(() => {\n\t\t\tuni.navigateBack()\n\t\t}, 1500)\n\t} catch (error) {\n\t\tconsole.error('保存失败:', error)\n\t\tuni.showToast({ \n\t\t\ttitle: error.message || '保存失败，请重试', \n\t\t\ticon: 'none',\n\t\t\tduration: 2000\n\t\t})\n\t} finally {\n\t\tsaving.value = false\n\t}\n}\n</script>\n\n<style scoped>\n.container {\n\tmin-height: 100vh;\n\tbackground-color: #F5F5F5;\n}\n\n.header {\n\tbackground-color: #007AFF;\n\tpadding: 40rpx;\n\ttext-align: center;\n}\n\n.title {\n\tfont-size: 36rpx;\n\tfont-weight: bold;\n\tcolor: #fff;\n}\n\n.form-section {\n\tpadding: 40rpx;\n}\n\n.avatar-section {\n\tbackground-color: #fff;\n\tborder-radius: 20rpx;\n\tpadding: 40rpx;\n\tmargin-bottom: 30rpx;\n\ttext-align: center;\n}\n\n.section-label {\n\tfont-size: 28rpx;\n\tcolor: #333;\n\tfont-weight: bold;\n\tmargin-bottom: 30rpx;\n\tdisplay: block;\n}\n\n.avatar-wrapper {\n\tposition: relative;\n\tdisplay: inline-block;\n\tmargin: 0 auto;\n}\n\n.avatar {\n\twidth: 200rpx;\n\theight: 200rpx;\n\tborder-radius: 50%;\n\tborder: 4rpx solid #E5E5E5;\n}\n\n.avatar-mask {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\tright: 0;\n\tbottom: 0;\n\tbackground-color: rgba(0, 0, 0, 0.5);\n\tborder-radius: 50%;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\topacity: 0;\n\ttransition: opacity 0.3s;\n}\n\n.avatar-wrapper:active .avatar-mask {\n\topacity: 1;\n}\n\n.avatar-text {\n\tcolor: #fff;\n\tfont-size: 24rpx;\n}\n\n.form-item {\n\tbackground-color: #fff;\n\tborder-radius: 20rpx;\n\tpadding: 30rpx;\n\tmargin-bottom: 20rpx;\n}\n\n.label {\n\tfont-size: 28rpx;\n\tcolor: #333;\n\tfont-weight: bold;\n\tmargin-bottom: 20rpx;\n\tdisplay: block;\n}\n\n.input {\n\twidth: 100%;\n\theight: 80rpx;\n\tbackground-color: #F5F5F5;\n\tborder-radius: 10rpx;\n\tpadding: 0 20rpx;\n\tfont-size: 28rpx;\n\tcolor: #333;\n}\n\n.save-btn {\n\twidth: 100%;\n\theight: 88rpx;\n\tbackground-color: #007AFF;\n\tcolor: #fff;\n\tborder-radius: 50rpx;\n\tfont-size: 32rpx;\n\tmargin-top: 40rpx;\n\tborder: none;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n}\n\n.save-btn:disabled {\n\tbackground-color: #CCCCCC;\n\topacity: 0.6;\n}\n</style>\n","import MiniProgramPage from 'G:/小程序xycy页面/SkyMark/pages/user/updata.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onLoad","checkLogin","uni","getCurrentUser","getCurrentUserId","userApi","saveUserInfo"],"mappings":"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"}